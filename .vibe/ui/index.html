<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIBE Pipeline Monitor</title>
<style>
  :root {
    --bg:      #0d0d14;
    --surface: #14141f;
    --border:  #1e1e2e;
    --text:    #e0e0e8;
    --dim:     #6b6b80;
    --blue:    #4a9eff;
    --green:   #34d399;
    --red:     #f87171;
    --amber:   #fbbf24;
    --grey:    #3a3a4a;
    --edge:    #2a2a3a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #header {
    padding: 14px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 20px;
    flex-shrink: 0;
  }
  #header h1 {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--blue);
  }
  #goal-text {
    font-size: 14px;
    color: var(--dim);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #status-badge {
    font-size: 12px;
    padding: 3px 12px;
    border-radius: 3px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    background: var(--grey);
    color: #e0e0e8;
  }
  #main-area {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  #canvas-wrapper {
    flex: 1;
    overflow: hidden;
    position: relative;
    background-color: var(--bg);
    background-image: radial-gradient(circle, #1e1e2e 1px, transparent 1px);
    background-size: 24px 24px;
  }
  #canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 1500px;
    height: 620px;
    transform-origin: top left;
  }
  #edges-svg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    overflow: visible;
  }
  .node {
    position: absolute;
    width: 168px;
    height: 76px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s, opacity 0.15s;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .node:hover { border-color: #4a4a6a; }
  .node.pending { opacity: 0.4; }
  .node.running {
    border-color: var(--blue);
    box-shadow: 0 0 16px rgba(74,158,255,0.22);
  }
  .node.passed { border-color: var(--green); }
  .node.failed { border-color: var(--red); }
  .node.skipped { opacity: 0.25; }
  .node.waiting_user { border-color: var(--amber); }
  .node-top {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .node-phase {
    font-size: 11px;
    color: var(--dim);
    background: var(--bg);
    padding: 1px 5px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .node-name {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }
  .node-warn {
    font-size: 12px;
    color: var(--amber);
    flex-shrink: 0;
  }
  .node-bottom {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .node-icon {
    font-size: 14px;
    width: 16px;
    text-align: center;
    flex-shrink: 0;
  }
  .node-status-text { font-size: 11px; color: var(--dim); }
  .node-activity {
    font-size: 11px;
    color: var(--blue);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; }
    50%      { opacity: 0.35; }
  }
  .node.running .node-icon { animation: pulse 1.2s ease-in-out infinite; }
  .node-selected { outline: 2px solid var(--blue) !important; outline-offset: 2px; }

  #detail-panel {
    width: 360px;
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }
  #agent-detail-scroll {
    flex: 0 0 auto;
    padding: 20px;
    overflow-y: auto;
    max-height: 55%;
  }
  #log-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-height: 0;
  }
  #log-panel-header {
    padding: 11px 20px;
    font-size: 11px;
    color: var(--dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-weight: 700;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #log-count {
    font-size: 11px;
    color: var(--dim);
    font-weight: 400;
    letter-spacing: 0;
  }
  #log-entries {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
    min-height: 0;
  }
  .log-entry {
    padding: 7px 20px;
    border-bottom: 1px solid var(--border);
    cursor: default;
  }
  .log-entry:last-child { border-bottom: none; }
  .log-entry-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 3px;
  }
  .log-agent {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--blue);
    flex-shrink: 0;
  }
  .log-time {
    font-size: 11px;
    color: var(--dim);
    flex-shrink: 0;
  }
  .log-artifact {
    font-size: 11px;
    color: var(--green);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .log-decision {
    font-size: 12px;
    color: var(--text);
    line-height: 1.35;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .dp-title {
    font-size: 11px;
    color: var(--blue);
    letter-spacing: 2px;
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 18px;
  }
  .dp-hint { font-size: 13px; color: var(--dim); }
  .dp-field { margin-bottom: 14px; }
  .dp-label {
    font-size: 11px;
    color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: block;
    margin-bottom: 3px;
  }
  .dp-value { font-size: 15px; color: var(--text); line-height: 1.4; }

  #summary-bar {
    padding: 10px 24px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 28px;
    font-size: 14px;
    color: var(--dim);
    flex-shrink: 0;
  }
  .metric { display: flex; align-items: center; gap: 7px; }
  .metric-val { color: var(--text); font-weight: 600; }
  .gates-row { display: flex; gap: 6px; align-items: center; }
  .gate-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--dim);
  }
  .gdot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--grey);
    flex-shrink: 0;
  }
  .gdot.passed { background: var(--green); }
  .gdot.failed { background: var(--red); }
  .run-count-pill {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--dim);
    flex-shrink: 0;
  }

  /* ── Content viewer modal ─── */
  #content-modal {
    position: fixed;
    inset: 0;
    z-index: 100;
    background: rgba(5,5,8,0.88);
    display: flex;
    flex-direction: column;
    padding: 32px;
  }
  #content-modal-inner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    max-width: 1100px;
    width: 100%;
    align-self: center;
  }
  #content-modal-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  #content-modal-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.3px;
  }
  #content-modal-label {
    font-size: 11px;
    color: var(--dim);
    flex: 1;
  }
  .cm-close {
    font-family: inherit;
    background: none;
    border: 1px solid var(--border);
    color: var(--dim);
    cursor: pointer;
    border-radius: 4px;
    padding: 3px 10px;
    font-size: 13px;
    flex-shrink: 0;
  }
  .cm-close:hover { border-color: var(--red); color: var(--red); }
  #content-modal-body {
    flex: 1;
    overflow: auto;
    padding: 20px;
    font-size: 12.5px;
    line-height: 1.65;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
    tab-size: 2;
  }

  /* ── Expandable log entries ─── */
  .log-expand-btn {
    font-size: 10px;
    color: var(--dim);
    cursor: pointer;
    padding: 1px 5px;
    flex-shrink: 0;
    border-radius: 3px;
    border: 1px solid transparent;
    line-height: 1.4;
    margin-left: auto;
  }
  .log-expand-btn:hover { color: var(--blue); border-color: var(--border); }
  .log-expanded {
    margin-top: 6px;
    padding: 8px 10px;
    background: var(--bg);
    border-radius: 4px;
    font-size: 11px;
    line-height: 1.7;
  }
  .log-exp-row {
    display: flex;
    gap: 8px;
    margin-bottom: 2px;
    align-items: baseline;
  }
  .log-exp-label {
    color: var(--dim);
    flex-shrink: 0;
    min-width: 84px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .log-exp-val { color: var(--text); }
  .log-exp-link {
    color: var(--blue);
    cursor: pointer;
    text-decoration: underline;
    font-size: 11px;
  }
  .log-exp-link:hover { color: var(--green); }
  .log-commit {
    font-family: 'SF Mono', monospace;
    font-size: 11px;
    color: var(--green);
    background: rgba(52,211,153,0.08);
    padding: 1px 6px;
    border-radius: 3px;
  }

  /* ── Action buttons in detail panel ─── */
  #dp-actions {
    padding: 14px 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-top: 1px solid var(--border);
  }
  .dp-btn {
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    padding: 7px 14px;
    border-radius: 5px;
    border: 1.5px solid;
    cursor: pointer;
    transition: opacity 0.15s, background 0.15s;
    text-align: center;
  }
  .dp-btn:hover { opacity: 0.8; }
  .dp-btn:active { opacity: 0.6; }
  .dp-btn.skip {
    background: transparent;
    border-color: var(--amber);
    color: var(--amber);
  }
  .dp-btn.unskip {
    background: transparent;
    border-color: var(--dim);
    color: var(--dim);
  }
  .dp-btn.reset {
    background: transparent;
    border-color: var(--red);
    color: var(--red);
  }
  .dp-btn.view {
    background: transparent;
    border-color: var(--blue);
    color: var(--blue);
  }

  /* ── File list in log entries ─── */
  .log-files {
    margin-top: 4px;
    padding: 4px 6px;
    background: var(--bg);
    border-radius: 3px;
    font-size: 11px;
    color: var(--dim);
    line-height: 1.55;
  }
  .log-files span {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .log-files .log-more {
    color: var(--blue);
    font-style: italic;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="header">
  <h1>VIBE</h1>
  <span id="goal-text">Waiting for pipeline...</span>
  <span id="status-badge">—</span>
</div>

<div id="main-area">
  <div id="canvas-wrapper">
    <div id="canvas">
      <svg id="edges-svg" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
  </div>
  <div id="detail-panel">
    <div id="agent-detail-scroll"></div>
    <div id="dp-actions" style="display:none"></div>
    <div id="log-panel">
      <div id="log-panel-header">
        Activity Log
        <span id="log-count"></span>
      </div>
      <div id="log-entries"></div>
    </div>
  </div>
</div>

<div id="summary-bar"></div>

<!-- ── Content viewer modal ──────────────────────────────────────────────── -->
<div id="content-modal" style="display:none">
  <div id="content-modal-inner">
    <div id="content-modal-header">
      <span id="content-modal-title"></span>
      <span id="content-modal-label"></span>
      <button class="cm-close" onclick="closeContentModal()">✕ close</button>
    </div>
    <pre id="content-modal-body"></pre>
  </div>
</div>

<script>
'use strict';

// ── Constants ─────────────────────────────────────────────────────────────────

const NW = 168, NH = 76;
const SVG_NS = 'http://www.w3.org/2000/svg';

const AGENTS = [
  { id: 'research',           label: 'Research',        phase: '1'   },
  { id: 'analyst',            label: 'Analyst',         phase: '2'   },
  { id: 'architect',          label: 'Architect',       phase: '3'   },
  { id: 'security_planner',   label: 'Sec. Planner',    phase: '4'   },
  { id: 'ux_designer',        label: 'UX Designer',     phase: '5'   },
  { id: 'implementer',        label: 'Implementer',     phase: '6'   },
  { id: 'test_writer',        label: 'Test Writer',     phase: '7'   },
  { id: 'critic',             label: 'Critic',          phase: '8'   },
  { id: 'fixer',              label: 'Fixer',           phase: '9'   },
  { id: 'security_auditor',   label: 'Sec. Auditor',    phase: '10'  },
  { id: 'performance_agent',  label: 'Performance',     phase: '10b' },
  { id: 'completeness_judge', label: 'Judge',           phase: '11'  },
  { id: 'documenter',         label: 'Documenter',      phase: '12'  },
  { id: 'deployer',           label: 'Deployer',        phase: '13'  },
];

// Node top-left positions — two-row layout (1500×620 logical canvas)
const POS = {
  // Row 1: phases 1–7 (y=50, step=200, node 168px wide → 32px gap)
  research:           { x: 80,   y: 50  },
  analyst:            { x: 280,  y: 50  },
  architect:          { x: 480,  y: 50  },
  security_planner:   { x: 680,  y: 50  },
  ux_designer:        { x: 880,  y: 50  },
  implementer:        { x: 1080, y: 50  },
  test_writer:        { x: 1280, y: 50  },
  // Row 2: phases 8–13 (y=340)
  critic:             { x: 240,  y: 340 },
  fixer:              { x: 240,  y: 490 },
  security_auditor:   { x: 490,  y: 250 },
  performance_agent:  { x: 490,  y: 410 },
  completeness_judge: { x: 740,  y: 340 },
  documenter:         { x: 940,  y: 340 },
  deployer:           { x: 1140, y: 340 },
};

const STATUS_ICON = {
  pending:      '\u25CB',
  running:      '\u25CF',
  passed:       '\u2713',
  failed:       '\u2717',
  skipped:      '\u2014',
  waiting_user: '\u23F8',
};

const STATUS_COLOR = {
  pending:      'var(--dim)',
  running:      'var(--blue)',
  passed:       'var(--green)',
  failed:       'var(--red)',
  skipped:      'var(--dim)',
  waiting_user: 'var(--amber)',
};

const GATE_LABELS = {
  prd_coverage:  'PRD',
  test_coverage: 'Tests',
  critic_score:  'Critic',
  security:      'Sec',
  performance:   'Perf',
};

// ── Agent → primary output artifact mapping ───────────────────────────────────
const AGENT_ARTIFACT = {
  research:           'research.md',
  analyst:            'prd.md',
  architect:          'architecture.md',
  security_planner:   'threat_model.md',
  ux_designer:        'ux_spec.md',
  critic:             'review_findings.md',
  security_auditor:   'security_findings.md',
  performance_agent:  'performance_findings.md',
  completeness_judge: 'done_report.md',
  deployer:           'deploy_options.md',
  // implementer, test_writer, fixer, documenter write code files — use commit diff instead
};

// ── Pricing (Claude Sonnet 4.6) ───────────────────────────────────────────────

const COST_INPUT_PER_1M  = 3.00;   // $ per 1M input tokens
const COST_OUTPUT_PER_1M = 15.00;  // $ per 1M output tokens

function fmtCost(tokIn, tokOut) {
  const cost = ((tokIn || 0) / 1e6) * COST_INPUT_PER_1M
             + ((tokOut || 0) / 1e6) * COST_OUTPUT_PER_1M;
  if (cost === 0) return null;
  if (cost < 0.01) return '~<$0.01';
  return '~$' + cost.toFixed(2);
}

// ── State ─────────────────────────────────────────────────────────────────────

let pipelineState   = null;
let usageData       = null;   // usage_totals.json (persists across resets)
let currentLog      = [];     // latest log entries (agent_actions.jsonl parsed)
let expandedLogs    = new Set(); // timestamps of expanded log entries
let selectedId      = null;
let nodeRefs        = {};  // agentId → { node, icon, statusTxt, activityEl, warnEl }
let dpRefs          = null;
let summaryRefs     = null;

// ── DOM helpers ───────────────────────────────────────────────────────────────

function mk(tag, cls) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  return e;
}

function svgEl(tag) {
  return document.createElementNS(SVG_NS, tag);
}

function setText(el, s) {
  el.textContent = String(s == null ? '' : s);
}

// ── Edge path helpers ─────────────────────────────────────────────────────────

function pt(id, side) {
  const p = POS[id];
  switch (side) {
    case 'r': return { x: p.x + NW,      y: p.y + NH / 2 };
    case 'l': return { x: p.x,           y: p.y + NH / 2 };
    case 'b': return { x: p.x + NW / 2,  y: p.y + NH     };
    case 't': return { x: p.x + NW / 2,  y: p.y          };
    default:  return { x: p.x,           y: p.y           };
  }
}

function hPath(s, t) {
  const dx = Math.abs(t.x - s.x);
  const off = Math.max(36, dx * 0.35);
  return `M${s.x},${s.y} C${s.x + off},${s.y} ${t.x - off},${t.y} ${t.x},${t.y}`;
}

function vPath(s, t) {
  const dy = Math.abs(t.y - s.y);
  const off = Math.max(28, dy * 0.4);
  return `M${s.x},${s.y} C${s.x},${s.y + off} ${t.x},${t.y - off} ${t.x},${t.y}`;
}

// ── Edge definitions ──────────────────────────────────────────────────────────

const EDGES = [
  // Row 1 — linear pipeline (phases 1–7)
  { id: 'res-ana', d: hPath(pt('research',        'r'), pt('analyst',          'l')) },
  { id: 'ana-arc', d: hPath(pt('analyst',         'r'), pt('architect',        'l')) },
  { id: 'arc-sp',  d: hPath(pt('architect',       'r'), pt('security_planner', 'l')) },
  { id: 'sp-ux',   d: hPath(pt('security_planner','r'), pt('ux_designer',      'l')) },
  { id: 'ux-imp',  d: hPath(pt('ux_designer',     'r'), pt('implementer',      'l')) },
  { id: 'imp-tw',  d: hPath(pt('implementer',     'r'), pt('test_writer',      'l')) },

  // Row 1 → Row 2: test_writer bottom → critic top (S-curve)
  {
    id: 'tw-cri',
    d: (function () {
      const s = pt('test_writer', 'b');
      const t = pt('critic', 't');
      const midY = Math.round((s.y + t.y) / 2);
      return `M${s.x},${s.y} C${s.x},${midY} ${t.x},${midY} ${t.x},${t.y}`;
    }()),
  },

  // Critic → Fixer (downward)
  {
    id: 'cri-fix',
    d: vPath(pt('critic', 'b'), pt('fixer', 't')),
    stroke: 'var(--amber)',
  },

  // Fixer → Critic (back-edge, curves left — the loop)
  {
    id: 'fix-cri',
    d: (function () {
      const s = pt('fixer',  'l');
      const t = pt('critic', 'l');
      const off = 70;
      return `M${s.x},${s.y} C${s.x - off},${s.y} ${t.x - off},${t.y} ${t.x},${t.y}`;
    }()),
    stroke: 'var(--amber)',
    dash: true,
  },

  // Critic → parallel agents (phases 10 + 10b)
  { id: 'cri-sa', d: hPath(pt('critic', 'r'), pt('security_auditor',  'l')) },
  { id: 'cri-pa', d: hPath(pt('critic', 'r'), pt('performance_agent', 'l')) },

  // Parallel → completeness_judge
  { id: 'sa-cj', d: hPath(pt('security_auditor',  'r'), pt('completeness_judge', 'l')) },
  { id: 'pa-cj', d: hPath(pt('performance_agent', 'r'), pt('completeness_judge', 'l')) },

  // Judge → Documenter → Deployer
  { id: 'cj-doc',  d: hPath(pt('completeness_judge', 'r'), pt('documenter', 'l')) },
  { id: 'doc-dep', d: hPath(pt('documenter',          'r'), pt('deployer',   'l')) },
];

// ── Build SVG edges ───────────────────────────────────────────────────────────

function buildEdges() {
  const svg = document.getElementById('edges-svg');

  const defs = svgEl('defs');

  function addMarker(id, color) {
    const m = svgEl('marker');
    m.setAttribute('id', id);
    m.setAttribute('markerWidth',  '8');
    m.setAttribute('markerHeight', '8');
    m.setAttribute('refX', '7');
    m.setAttribute('refY', '3');
    m.setAttribute('orient', 'auto');
    const p = svgEl('path');
    p.setAttribute('d', 'M0,0 L0,6 L8,3 z');
    p.setAttribute('fill', color);
    m.appendChild(p);
    defs.appendChild(m);
  }

  addMarker('arr-grey',  'var(--edge)');
  addMarker('arr-amber', 'var(--amber)');
  svg.appendChild(defs);

  for (const edge of EDGES) {
    const path = svgEl('path');
    path.setAttribute('d', edge.d);
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke', edge.stroke || 'var(--edge)');
    path.setAttribute('stroke-width', '1.5');
    if (edge.dash) path.setAttribute('stroke-dasharray', '5,4');
    path.setAttribute('marker-end', edge.stroke ? 'url(#arr-amber)' : 'url(#arr-grey)');
    svg.appendChild(path);
  }
}

// ── Build nodes ───────────────────────────────────────────────────────────────

function buildNodes() {
  const canvas = document.getElementById('canvas');

  for (const agent of AGENTS) {
    const pos = POS[agent.id];
    if (!pos) continue;

    const node = mk('div', 'node pending');
    node.style.left = pos.x + 'px';
    node.style.top  = pos.y + 'px';

    // Top row: phase badge + name + warn badge
    const top = mk('div', 'node-top');
    const phase = mk('span', 'node-phase');
    setText(phase, agent.phase);
    const name = mk('span', 'node-name');
    setText(name, agent.label);
    const warn = mk('span', 'node-warn');
    setText(warn, '\u26A0');
    warn.style.display = 'none';
    warn.title = 'Input tokens exceeded 8,000 threshold';
    top.appendChild(phase);
    top.appendChild(name);
    top.appendChild(warn);

    // Bottom row: status icon + status text OR activity text
    const bottom = mk('div', 'node-bottom');
    const icon = mk('span', 'node-icon');
    setText(icon, STATUS_ICON.pending);
    icon.style.color = STATUS_COLOR.pending;
    const statusTxt = mk('span', 'node-status-text');
    setText(statusTxt, 'pending');
    const activityEl = mk('span', 'node-activity');
    activityEl.style.display = 'none';
    bottom.appendChild(icon);
    bottom.appendChild(statusTxt);
    bottom.appendChild(activityEl);

    node.appendChild(top);
    node.appendChild(bottom);

    node.addEventListener('click', () => selectAgent(agent.id));
    canvas.appendChild(node);

    nodeRefs[agent.id] = { node, icon, statusTxt, activityEl, warn };
  }
}

// ── Build detail panel ────────────────────────────────────────────────────────

function buildDetailPanel() {
  const panel = document.getElementById('agent-detail-scroll');

  const title = mk('div', 'dp-title');
  setText(title, 'Agent Detail');
  panel.appendChild(title);

  const hint = mk('div', 'dp-hint');
  setText(hint, 'Click a node to inspect');
  panel.appendChild(hint);

  const fieldDefs = [
    { key: 'name',      label: 'Name'           },
    { key: 'phase',     label: 'Phase'          },
    { key: 'status',    label: 'Status'         },
    { key: 'activity',  label: 'Activity'       },
    { key: 'duration',  label: 'Duration'       },
    { key: 'tokensIn',  label: 'Tokens In'      },
    { key: 'tokensOut', label: 'Tokens Out'     },
    { key: 'agentCost', label: 'Est. Cost'      },
    { key: 'lastError', label: 'Error'          },
    { key: 'warnMsg',   label: '\u26A0 Warning' },
  ];

  const fields = {};
  for (const { key, label } of fieldDefs) {
    const field = mk('div', 'dp-field');
    field.style.display = 'none';
    const lbl = mk('span', 'dp-label');
    setText(lbl, label);
    const val = mk('div', 'dp-value');
    field.appendChild(lbl);
    field.appendChild(val);
    panel.appendChild(field);
    fields[key] = { field, val };
  }

  return { hint, fields };
}

// ── Build summary bar ─────────────────────────────────────────────────────────

function buildSummaryBar() {
  const bar = document.getElementById('summary-bar');

  function addMetric(labelStr, extraCls) {
    const m = mk('div', 'metric' + (extraCls ? ' ' + extraCls : ''));
    const lbl = mk('span');
    setText(lbl, labelStr);
    const val = mk('span', 'metric-val');
    m.appendChild(lbl);
    m.appendChild(val);
    bar.appendChild(m);
    return { metric: m, val };
  }

  const { val: sessionVal }  = addMetric('Session:');

  // All-time metric — hidden until usage_totals.json exists
  const allTimeMetric = mk('div', 'metric');
  const allTimeLbl = mk('span');
  setText(allTimeLbl, 'All-time:');
  const allTimeVal = mk('span', 'metric-val');
  allTimeMetric.appendChild(allTimeLbl);
  allTimeMetric.appendChild(allTimeVal);
  allTimeMetric.style.display = 'none';
  bar.appendChild(allTimeMetric);

  // Run count pill — hidden until usage data available
  const runCountPill = mk('span', 'run-count-pill');
  runCountPill.style.display = 'none';
  bar.appendChild(runCountPill);

  const { val: elapsedVal } = addMetric('Elapsed:');
  const { val: phasesVal  } = addMetric('Phases:');

  const gatesMetric = mk('div', 'metric');
  const gatesLbl = mk('span');
  setText(gatesLbl, 'Gates:');
  const gatesRow = mk('div', 'gates-row');
  gatesMetric.appendChild(gatesLbl);
  gatesMetric.appendChild(gatesRow);
  bar.appendChild(gatesMetric);

  return { sessionVal, allTimeMetric, allTimeVal, runCountPill, elapsedVal, phasesVal, gatesRow };
}

// ── Update helpers ────────────────────────────────────────────────────────────

function fmtTokens(n) {
  if (n == null) return '—';
  if (n === 0) return '0';
  return n >= 1000 ? (n / 1000).toFixed(1) + 'k' : String(n);
}

function fmtTime(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
}

function fmtElapsed(startedAt) {
  if (!startedAt) return '--:--';
  const secs = Math.floor((Date.now() - new Date(startedAt).getTime()) / 1000);
  const m = Math.floor(secs / 60);
  const s = String(secs % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function fmtDuration(ms) {
  if (ms == null) return null;
  const secs = Math.floor(ms / 1000);
  const m    = Math.floor(secs / 60);
  const s    = secs % 60;
  return m > 0 ? `${m}m ${s}s` : `${s}s`;
}

// ── Content viewer modal ───────────────────────────────────────────────────────

function showContentModal(title, url, label) {
  const modal   = document.getElementById('content-modal');
  const titleEl = document.getElementById('content-modal-title');
  const labelEl = document.getElementById('content-modal-label');
  const body    = document.getElementById('content-modal-body');

  modal.style.display = 'flex';
  setText(titleEl, title);
  setText(labelEl, label || '');
  body.textContent = 'Loading…';
  body.style.color = 'var(--dim)';

  fetch(url)
    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
    .then(text => {
      body.style.color = '';
      try {
        // Pretty-print JSON artifacts
        body.textContent = JSON.stringify(JSON.parse(text), null, 2);
      } catch {
        body.textContent = text;
      }
    })
    .catch(err => {
      body.style.color = 'var(--red)';
      body.textContent = 'Error: ' + err.message;
    });
}

function closeContentModal() {
  document.getElementById('content-modal').style.display = 'none';
}

// ── API calls to server mutation endpoints ────────────────────────────────────

async function api(method, path) {
  try {
    const r = await fetch(path, { method });
    if (!r.ok) {
      const body = await r.json().catch(() => ({}));
      console.error(`API ${method} ${path} failed:`, body.error || r.status);
    }
  } catch (err) {
    console.error(`API ${method} ${path} error:`, err);
  }
}

// ── Select agent ──────────────────────────────────────────────────────────────

function selectAgent(id) {
  // Clear previous selection outline
  if (selectedId && nodeRefs[selectedId]) {
    nodeRefs[selectedId].node.classList.remove('node-selected');
  }
  selectedId = id;
  if (nodeRefs[id]) {
    nodeRefs[id].node.classList.add('node-selected');
  }
  renderDetailPanel();
  renderActionButtons();
}

// ── Render functions ──────────────────────────────────────────────────────────

function renderNodes(agents) {
  for (const agent of AGENTS) {
    const refs = nodeRefs[agent.id];
    if (!refs) continue;
    const s = (agents || {})[agent.id] || {};
    const status = s.status || 'pending';

    refs.node.className = 'node ' + status + (selectedId === agent.id ? ' node-selected' : '');

    setText(refs.icon, STATUS_ICON[status] || STATUS_ICON.pending);
    refs.icon.style.color = STATUS_COLOR[status] || STATUS_COLOR.pending;

    if (s.activity) {
      refs.statusTxt.style.display = 'none';
      refs.activityEl.style.display = '';
      setText(refs.activityEl, s.activity);
    } else {
      refs.activityEl.style.display = 'none';
      refs.statusTxt.style.display = '';
      setText(refs.statusTxt, status);
    }

    refs.warn.style.display = (s.tokens_in || 0) > 8000 ? '' : 'none';
  }
}

function buildLogExpanded(entry) {
  const box = mk('div', 'log-expanded');

  function row(label, content) {
    const r = mk('div', 'log-exp-row');
    const lbl = mk('span', 'log-exp-label');
    setText(lbl, label);
    r.appendChild(lbl);
    r.appendChild(content);
    box.appendChild(r);
  }

  // Artifacts read
  const arts = (entry.context && entry.context.artifacts_read) || [];
  if (arts.length) {
    const v = mk('span', 'log-exp-val');
    setText(v, arts.join(', '));
    row('Read', v);
  }

  // Skills injected
  const skills = (entry.context && entry.context.skills_injected) || [];
  const skillsVal = mk('span', 'log-exp-val');
  setText(skillsVal, skills.length ? skills.join(', ') : 'none');
  row('Skills', skillsVal);

  // Iteration (critic/fixer)
  if (entry.iteration != null && entry.iteration > 0) {
    const v = mk('span', 'log-exp-val');
    setText(v, `${entry.iteration}`);
    row('Iteration', v);
  }

  // Gate result
  if (entry.gate_result != null) {
    const v = mk('span', 'log-exp-val');
    setText(v, entry.gate_result ? '✓ passed' : '✗ failed');
    v.style.color = entry.gate_result ? 'var(--green)' : 'var(--red)';
    row('Gate', v);
  }

  // Commit hash + diff link
  if (entry.commit) {
    const wrap = mk('span');
    const chip = mk('span', 'log-commit');
    setText(chip, entry.commit);
    wrap.appendChild(chip);
    if (entry.commit.length >= 6) {
      const link = mk('span', 'log-exp-link');
      setText(link, '  view diff →');
      link.addEventListener('click', () => {
        const agentDef = AGENTS.find(a => a.id === entry.agent);
        showContentModal(
          (agentDef ? agentDef.label : entry.agent) + ' — Commit ' + entry.commit,
          `/commit-diff/${entry.commit}`,
          `git show ${entry.commit}`,
        );
      });
      wrap.appendChild(link);
    }
    row('Commit', wrap);
  }

  // Artifact view link
  if (entry.artifact_written) {
    const name = entry.artifact_written.split('/').pop();
    const link = mk('span', 'log-exp-link');
    setText(link, name + ' →');
    link.addEventListener('click', () => {
      showContentModal(name, `/artifact/${name}`, entry.artifact_written);
    });
    row('Artifact', link);
  }

  // Files written
  const files = Array.isArray(entry.files_written) ? entry.files_written : [];
  if (files.length) {
    const v = mk('div', 'log-exp-val');
    const SHOW = 4;
    files.slice(0, SHOW).forEach(f => {
      const s = mk('div');
      setText(s, f);
      v.appendChild(s);
    });
    if (files.length > SHOW) {
      const more = mk('span', 'log-exp-link');
      setText(more, `+ ${files.length - SHOW} more`);
      let shown = false;
      more.addEventListener('click', () => {
        if (shown) return;
        shown = true;
        more.remove();
        files.slice(SHOW).forEach(f => {
          const s = mk('div');
          setText(s, f);
          v.appendChild(s);
        });
      });
      v.appendChild(more);
    }
    row('Files', v);
  }

  return box;
}

function renderLogFeed(entries) {
  const container = document.getElementById('log-entries');
  const countEl   = document.getElementById('log-count');
  if (!container) return;

  const count = entries.length;
  setText(countEl, count ? `(${count})` : '');

  // Re-render only if count changed OR expanded set changed
  const cacheKey = String(count) + ':' + expandedLogs.size;
  if (container.dataset.cacheKey === cacheKey) return;
  container.dataset.cacheKey = cacheKey;

  const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 4;
  while (container.firstChild) container.removeChild(container.firstChild);

  for (const entry of entries) {
    const isExpanded = expandedLogs.has(entry.timestamp);
    const row = mk('div', 'log-entry');

    // Header row
    const hdr = mk('div', 'log-entry-header');

    const agentEl = mk('span', 'log-agent');
    setText(agentEl, (entry.agent || '?').replace(/_/g, ' '));
    hdr.appendChild(agentEl);

    const timeEl = mk('span', 'log-time');
    setText(timeEl, fmtTime(entry.timestamp));
    hdr.appendChild(timeEl);

    if (entry.artifact_written) {
      const art = mk('span', 'log-artifact');
      setText(art, '→ ' + entry.artifact_written.split('/').pop());
      hdr.appendChild(art);
    }

    // Expand/collapse toggle
    const expandBtn = mk('span', 'log-expand-btn');
    setText(expandBtn, isExpanded ? '▲' : '▼');
    expandBtn.title = isExpanded ? 'Collapse' : 'Expand details';
    expandBtn.addEventListener('click', () => {
      if (expandedLogs.has(entry.timestamp)) {
        expandedLogs.delete(entry.timestamp);
      } else {
        expandedLogs.add(entry.timestamp);
      }
      renderLogFeed(currentLog);
    });
    hdr.appendChild(expandBtn);

    row.appendChild(hdr);

    // Decision line
    if (entry.decision) {
      const dec = mk('div', 'log-decision');
      setText(dec, entry.decision);
      row.appendChild(dec);
    }

    // Expanded detail block
    if (isExpanded) {
      row.appendChild(buildLogExpanded(entry));
    }

    container.appendChild(row);
  }

  if (wasAtBottom) container.scrollTop = container.scrollHeight;
}

// ── Action buttons (Skip / Reset from here) ───────────────────────────────────

function renderActionButtons() {
  const actionsDiv = document.getElementById('dp-actions');
  if (!actionsDiv) return;

  // Clear existing buttons
  while (actionsDiv.firstChild) actionsDiv.removeChild(actionsDiv.firstChild);

  if (!selectedId) {
    actionsDiv.style.display = 'none';
    return;
  }

  const s = (pipelineState && pipelineState.agents && pipelineState.agents[selectedId]) || {};
  const status = s.status || 'pending';

  // Running agents: no actions (don't interrupt live work)
  if (status === 'running') {
    actionsDiv.style.display = 'none';
    return;
  }

  let hasButtons = false;

  // View Input — for any agent that has had a context file written
  // (we speculatively try; if 404 the modal shows the error)
  if (['passed', 'failed', 'skipped', 'running'].includes(status)) {
    const btn = mk('button', 'dp-btn view');
    setText(btn, 'View Input Context');
    btn.title = `Show the exact context passed into ${selectedId}`;
    btn.addEventListener('click', () => {
      const agent = AGENTS.find(a => a.id === selectedId);
      showContentModal(
        (agent ? agent.label : selectedId) + ' — Input Context',
        `/context/${selectedId}`,
        `.vibe/context/${selectedId}_input.md`,
      );
    });
    actionsDiv.appendChild(btn);
    hasButtons = true;
  }

  // View Output / View Commit — for passed agents
  if (status === 'passed') {
    const artifact = AGENT_ARTIFACT[selectedId];
    if (artifact) {
      const btn = mk('button', 'dp-btn view');
      setText(btn, 'View Output Artifact');
      btn.title = `Show ${artifact}`;
      btn.addEventListener('click', () => {
        const agent = AGENTS.find(a => a.id === selectedId);
        showContentModal(
          (agent ? agent.label : selectedId) + ' — Output',
          `/artifact/${artifact}`,
          `.vibe/artifacts/${artifact}`,
        );
      });
      actionsDiv.appendChild(btn);
      hasButtons = true;
    } else {
      // Code-writing agents: offer commit diff instead
      const agentState = (pipelineState && pipelineState.agents && pipelineState.agents[selectedId]) || {};
      // Find commit from log entries
      const logEntry = currentLog.slice().reverse().find(e => e.agent === selectedId && e.commit);
      if (logEntry && logEntry.commit) {
        const btn = mk('button', 'dp-btn view');
        setText(btn, 'View Commit Diff');
        btn.title = `Show git diff for commit ${logEntry.commit}`;
        btn.addEventListener('click', () => {
          const agent = AGENTS.find(a => a.id === selectedId);
          showContentModal(
            (agent ? agent.label : selectedId) + ' — Commit ' + logEntry.commit,
            `/commit-diff/${logEntry.commit}`,
            `git show ${logEntry.commit}`,
          );
        });
        actionsDiv.appendChild(btn);
        hasButtons = true;
      }
    }
  }

  // Skip / Unskip — for pending and skipped agents
  if (status === 'pending') {
    const btn = mk('button', 'dp-btn skip');
    setText(btn, 'Skip this agent');
    btn.title = 'Mark agent as skipped — it will be bypassed on the next /vibe continue';
    btn.addEventListener('click', () => api('POST', `/skip/${selectedId}`));
    actionsDiv.appendChild(btn);
    hasButtons = true;
  } else if (status === 'skipped') {
    const btn = mk('button', 'dp-btn unskip');
    setText(btn, 'Restore (un-skip)');
    btn.title = 'Mark agent as pending so it runs on the next /vibe continue';
    btn.addEventListener('click', () => api('POST', `/unskip/${selectedId}`));
    actionsDiv.appendChild(btn);
    hasButtons = true;
  }

  // Reset from here — for any agent that has already run or been skipped
  if (['passed', 'failed', 'waiting_user', 'skipped'].includes(status)) {
    const btn = mk('button', 'dp-btn reset');
    setText(btn, 'Reset from here');
    btn.title = `Reset this agent and all subsequent agents to pending. Run /vibe continue to re-run from ${selectedId}.`;
    btn.addEventListener('click', async () => {
      if (confirm(`Reset "${selectedId}" and all agents after it to pending?\n\nThis cannot be undone. Run /vibe continue to resume from this point.`)) {
        await api('POST', `/reset/${selectedId}`);
      }
    });
    actionsDiv.appendChild(btn);
    hasButtons = true;
  }

  actionsDiv.style.display = hasButtons ? '' : 'none';
}

function renderDetailPanel() {
  if (!dpRefs) return;
  const { hint, fields } = dpRefs;

  function show(key, valueStr, color) {
    const f = fields[key];
    if (!f) return;
    f.field.style.display = '';
    setText(f.val, valueStr);
    f.val.style.color = color || 'var(--text)';
  }
  function hide(key) {
    const f = fields[key];
    if (f) f.field.style.display = 'none';
  }

  if (!selectedId) {
    hint.style.display = '';
    for (const f of Object.values(fields)) f.field.style.display = 'none';
    return;
  }

  hint.style.display = 'none';
  const agent = AGENTS.find(a => a.id === selectedId);
  const s = (pipelineState && pipelineState.agents && pipelineState.agents[selectedId]) || {};
  const status = s.status || 'pending';

  show('name',     agent ? agent.label : selectedId);
  show('phase',    agent ? String(agent.phase) : '');
  show('status',   STATUS_ICON[status] + ' ' + status, STATUS_COLOR[status] || 'var(--text)');

  if (s.activity) show('activity', s.activity);
  else            hide('activity');

  const dur = fmtDuration(s.duration_ms);
  if (dur) show('duration', dur);
  else     hide('duration');

  show('tokensIn',  fmtTokens(s.tokens_in));
  show('tokensOut', fmtTokens(s.tokens_out));

  const agentCost = fmtCost(s.tokens_in, s.tokens_out);
  if (agentCost) show('agentCost', agentCost, 'var(--green)');
  else           hide('agentCost');

  if (s.last_error) show('lastError', s.last_error, 'var(--red)');
  else              hide('lastError');

  if ((s.tokens_in || 0) > 8000) {
    show('warnMsg', 'Input exceeded 8,000 token threshold', 'var(--amber)');
  } else {
    hide('warnMsg');
  }
}

function renderHeader(state) {
  const goalEl = document.getElementById('goal-text');
  const badge  = document.getElementById('status-badge');
  setText(goalEl, state && state.goal ? state.goal : 'Initialising...');
  const st = (state && state.status) || 'unknown';
  setText(badge, st);
  const bgMap = { complete: '#34d399', running: '#4a9eff', failed: '#f87171', interrupted: '#fbbf24', escalated: '#f87171', initialising: '#3a3a4a' };
  badge.style.background = bgMap[st] || '#3a3a4a';
  badge.style.color = (st === 'initialising' || st === 'unknown') ? 'var(--dim)' : '#050508';
}

function renderSummaryBar(state) {
  if (!summaryRefs) return;
  const { sessionVal, allTimeMetric, allTimeVal, runCountPill, elapsedVal, phasesVal, gatesRow } = summaryRefs;

  // Session tokens + cost
  const ti = (state && state.token_totals && state.token_totals.in)  || 0;
  const to = (state && state.token_totals && state.token_totals.out) || 0;
  const sessionCost = fmtCost(ti, to);
  setText(sessionVal, fmtTokens(ti) + ' in / ' + fmtTokens(to) + ' out' + (sessionCost ? '  ' + sessionCost : ''));

  // All-time tokens + cost (from usage_totals.json)
  if (usageData && (usageData.all_time_in || usageData.all_time_out)) {
    const ati = usageData.all_time_in  || 0;
    const ato = usageData.all_time_out || 0;
    const atCost = fmtCost(ati, ato);
    setText(allTimeVal, fmtTokens(ati) + ' in / ' + fmtTokens(ato) + ' out' + (atCost ? '  ' + atCost : ''));
    allTimeMetric.style.display = '';
    if (usageData.run_count > 1) {
      setText(runCountPill, usageData.run_count + ' runs');
      runCountPill.style.display = '';
    } else {
      runCountPill.style.display = 'none';
    }
  } else {
    allTimeMetric.style.display = 'none';
    runCountPill.style.display  = 'none';
  }

  setText(elapsedVal, fmtElapsed(state && state.started_at));

  const agents = (state && state.agents) || {};
  const done  = Object.values(agents).filter(a => a.status === 'passed' || a.status === 'skipped').length;
  setText(phasesVal, done + '/' + AGENTS.length);

  // Gates — rebuild pills
  while (gatesRow.firstChild) gatesRow.removeChild(gatesRow.firstChild);
  const gates = (state && state.gates) || {};
  for (const [key, val] of Object.entries(gates)) {
    const pill = mk('div', 'gate-pill');
    const dot  = mk('span', 'gdot' + (val === null ? '' : val ? ' passed' : ' failed'));
    const lbl  = mk('span');
    setText(lbl, GATE_LABELS[key] || key);
    pill.title = key + ': ' + (val === null ? 'pending' : val ? 'passed' : 'failed');
    pill.appendChild(dot);
    pill.appendChild(lbl);
    gatesRow.appendChild(pill);
  }
}

// ── Main update (called on every SSE event) ───────────────────────────────────

function onUpdate(payload) {
  pipelineState = payload.state;
  usageData     = payload.usage || null;
  currentLog    = payload.log  || [];
  if (!pipelineState) return;

  renderHeader(pipelineState);
  renderNodes(pipelineState.agents);
  renderDetailPanel();
  renderActionButtons();
  renderSummaryBar(pipelineState);
  renderLogFeed(payload.log || []);

  // Auto-select the running agent if nothing is selected
  if (!selectedId) {
    const entry = Object.entries(pipelineState.agents || {}).find(([, a]) => a.status === 'running');
    if (entry) selectAgent(entry[0]);
  }
}

// ── Initialise ────────────────────────────────────────────────────────────────

buildEdges();
buildNodes();
dpRefs      = buildDetailPanel();
summaryRefs = buildSummaryBar();

// Scale canvas to fit the wrapper — called on init and every resize
function fitCanvas() {
  const wrapper = document.getElementById('canvas-wrapper');
  const canvas  = document.getElementById('canvas');
  if (!wrapper || !canvas) return;
  const scale = Math.min(wrapper.clientWidth / 1500, wrapper.clientHeight / 620);
  canvas.style.transform = `scale(${scale})`;
}
fitCanvas();
window.addEventListener('resize', fitCanvas);

// Close content modal on Escape, or on backdrop click
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeContentModal();
});
document.getElementById('content-modal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeContentModal();
});

// Tick elapsed timer every second
setInterval(() => {
  if (pipelineState && summaryRefs) renderSummaryBar(pipelineState);
}, 1000);

// SSE connection
const es = new EventSource('/events');
es.onmessage = function (e) {
  try { onUpdate(JSON.parse(e.data)); } catch (err) { console.error('SSE parse error', err); }
};
es.onerror = function () {
  if (!pipelineState) {
    setText(document.getElementById('goal-text'), 'Connecting to monitor...');
  }
};
</script>
</body>
</html>
